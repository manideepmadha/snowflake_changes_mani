name: Code Quality Check

on:
  pull_request:
    branches: [main] # or any other branches you want to check
permissions:
  contents: read
  pull-requests: write

jobs:
  pythonFiles: # List out changed/added Python files
    runs-on: ubuntu-latest
    outputs:
      pythonfiles: ${{ steps.set-python-files.outputs.pythonfiles }}

    steps:
      - name: Clone Repo
        uses: actions/checkout@v3

      - name: Get changed/added files
        run: |
          git fetch --no-tags --prune --depth=1 origin +refs/heads/${{ github.event.pull_request.base.ref }}:refs/remotes/origin/${{ github.event.pull_request.base.ref }}

      - name: Get Python files
        id: set-python-files
        run: echo "pythonfiles=$(git diff --name-only --diff-filter=ACMRT origin/${{ github.event.pull_request.base.ref }} HEAD -- '*.py' | uniq | jq -R -s -c 'split("\n")[:-1]' | jq -r '.[] | ("./" + .)' | jq -R -r -s -c 'split("\n")[:-1] | join(" ")')" >>$GITHUB_OUTPUT

      - name: Print files to be scanned
        run: echo ${{ steps.set-python-files.outputs.pythonfiles }}

  Code_Analysis:
    runs-on: ubuntu-latest
    needs: pythonFiles
    if: ${{ needs.pythonFiles.outputs.pythonfiles != '' }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v3

      - name: Set up Python
        uses: actions/setup-python@v3
        with:
          python-version: '3.x' # Specify your desired Python version

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pylint radon pyflakes bandit vulture

      - name: Analyze code
        run: |
          set -e
          echo "Analyzing files: ${{ needs.pythonFiles.outputs.pythonfiles }}"

          # Pylint analysis
          echo "Running Pylint..."
          pylint --disable=R,C --output-format=text ${{ needs.pythonFiles.outputs.pythonfiles }} > pylint_report.txt || echo "Pylint failed."

          # Cyclomatic complexity analysis
          echo "Running Radon CC..."
          radon cc ${{ needs.pythonFiles.outputs.pythonfiles }} > cc_report.txt || echo "Radon failed."

          # Boilerplate detection
          echo "Running Pyflakes..."
          pyflakes ${{ needs.pythonFiles.outputs.pythonfiles }} > pyflakes_report.txt || echo "Pyflakes failed."

          # Security checks
          echo "Running Bandit..."
          bandit -r ${{ needs.pythonFiles.outputs.pythonfiles }} > bandit_report.txt || echo "Bandit failed."

          # Unused code detection
          echo "Running Vulture..."
          vulture ${{ needs.pythonFiles.outputs.pythonfiles }} > vulture_report.txt || echo "Vulture failed."

      - name: Calculate code rating (basic example)
        run: |
          set -e
          pylint_score=$(grep "Your code has been rated at" pylint_report.txt | awk '{print $6}' || echo "N/A")
          avg_complexity=$(grep "Average complexity" cc_report.txt | awk '{print $3}' || echo "N/A")
          bandit_issues=$(grep -c "Issue:" bandit_report.txt)
          rating="★★★"
          rating_color="yellow" 
          reason="Default rating."
          if [[ $pylint_score != "N/A" && $avg_complexity != "NA" ]]; then
            if [[ $(echo "$pylint_score > 9" | bc -l) -eq 1 ]] && [[ $(echo "$avg_complexity < 5" | bc -l) -eq 1 ]] && [[ $bandit_issues -eq 0 ]]; then
              rating="★★★★★"
              rating_color="green"
              reason="Excellent Pylint score, low cyclomatic complexity, and no security issues."
            elif [[ $(echo "$pylint_score > 8" | bc -l) -eq 1 ]] && [[ $(echo "$avg_complexity < 10" | bc -l) -eq 1 ]] && [[ $bandit_issues -lt 5 ]]; then
              rating="★★★★"
              rating_color="green"
              reason="Good Pylint score, moderate complexity, and minor security issues."
            elif [[ $(echo "$pylint_score > 6" | bc -l) -eq 1 ]] && [[ $bandit_issues -lt 10 ]]; then
              rating="★★★"
              rating_color="yellow"
            else
              rating="★★"
              rating_color="red"
            fi
          fi
          echo "Code Rating: $rating ($reason)" > code_rating.txt
          echo "Rating Color: $rating_color" > rating_color.txt

      - name: Create PR comment
        uses: actions/github-script@v6
        with:
          token: ${{ secrets.PAT_GITHUB_TOKEN }}
          script: |
            const fs = require('fs');
            const pylintReport = fs.readFileSync('pylint_report.txt', 'utf8');
            const ccReport = fs.readFileSync('cc_report.txt', 'utf8');
            const pyflakesReport = fs.readFileSync('pyflakes_report.txt', 'utf8');
            const banditReport = fs.readFileSync('bandit_report.txt', 'utf8');
            const vultureReport = fs.readFileSync('vulture_report.txt', 'utf8');
            const codeRating = fs.readFileSync('code_rating.txt', 'utf8');
            const ratingColor = fs.readFileSync('rating_color.txt', 'utf8');
            const changedFiles = `${{ needs.pythonFiles.outputs.pythonfiles }}`;

            const commentBody = `
              <table border="1">
                <tr>
                  <td style="background-color:${ratingColor};">**Rating:**</td>
                  <td>${rating}</td>
                </tr>
                <tr>
                  <td>**Code Quality (Pylint)**</td>
                  <td>${pylintReport.match(/Your code has been rated at ([0-9.]+)\/10\./)?.[1] || "N/A"}</td>
                </tr>
                <tr>
                  <td>**Complexity (Radon)**</td>
                  <td>${ccReport.match(/Average complexity: ([0-9.]+)/)?.[1] || "N/A"}</td>
                </tr>
                <tr>
                  <td>**Boilerplate Code**</td>
                  <td>${vultureReport.slice(0, 100)}</td> 
                </tr>
                <tr>
                  <td>**Security Issues (Bandit)**</td>
                  <td>${banditReport.slice(0, 100)}</td> 
                </tr>
              </table>

              **Summary:**
              ${codeRating} - ${reason}

              **Changed Files:**
              ${changedFiles}`;

            github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: commentBody
            });
      